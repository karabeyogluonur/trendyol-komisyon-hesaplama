@model ProductCostListViewModel

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel("Maliyet Yönetimi", "Maliyet Yönetimi"))


<app-alert type="Info" title="Maliyet ve Komisyon Yönetimi Hakkında Bilgilendirme" dismissible="true"
    class="mb-10 border-dashed border-primary">

    <div class="fs-7 text-gray-700">
        <p class="mb-3">Maliyet ekranı, satış kârlılığınızı etkileyen değişkenlerin yönetildiği dinamik bir alandır.
            Alanların işleyişi şu şekildedir:</p>

        <ul class="list-unstyled mb-0">
            <li class="d-flex align-items-center mb-2">
                <span class="bullet bullet-dot bg-primary me-2"></span>
                <span class="fw-bold text-gray-800 me-1">Alış Fiyatı:</span>
                Analizlerin temelini oluşturur ve girilmesi zorunludur. Boş bırakılması durumunda kâr hesaplaması
                yapılamaz.
            </li>

            <li class="d-flex align-items-center mb-2">
                <span class="bullet bullet-dot bg-primary me-2"></span>
                <span class="fw-bold text-gray-800 me-1">Manuel Alanlar (Giriş Yapılabilir):</span>
                Komisyon veya kargo ücretine değer girdiğinizde sistem otomatik hesaplamayı devre dışı bırakır ve sizin
                verinizi öncelikli kabul eder.
            </li>

            <li class="d-flex align-items-center mb-2">
                <span class="bullet bullet-dot bg-warning me-2"></span>
                <span class="fw-bold text-warning me-1">Otomatik Hesaplama (<i
                        class="ki-outline ki-calculator fs-7 text-warning"></i>):</span>
                Sarı renkli alanlar, pazar yeri komisyon oranları ve kargo desilerine göre sistem tarafından anlık
                hesaplanan değerlerdir.
            </li>

            <li class="d-flex align-items-center">
                <span class="bullet bullet-dot bg-success me-2"></span>
                <span>Değişiklik yapılan satırlar <span class="text-primary fw-bold">mavi renkle</span> vurgulanır.
                    İşleminiz bitince <span class="badge badge-light-primary fw-bolder">Tümünü Kaydet</span> butonu ile
                    güncellemeleri tamamlayabilirsiniz.</span>
            </li>
        </ul>
    </div>
</app-alert>

<div class="card card-flush mt-5">
    <div class="card-header border-0 pt-6">
        <form method="get" class="w-100" id="filterForm">
            <input type="hidden" name="PageIndex" value="1" />
            <div class="row g-5 align-items-end">
                <div class="col-12 col-md-4 col-lg-2">
                    <label class="form-label fs-7 fw-bold text-gray-700">Arama</label>
                    <div class="position-relative">
                        <i class="ki-outline ki-magnifier fs-3 position-absolute top-50 translate-middle-y ms-4"></i>
                        <input type="text" name="Barcode" value="@Model.Filter.Barcode"
                            class="form-control form-control-sm form-control-solid ps-12 fs-7"
                            placeholder="Barkod ara..." />
                    </div>
                </div>

                <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                    <label class="form-label fs-7 fw-bold text-gray-700">Kategori</label>
                    <app-filter-select asp-for="Filter.CategoryId" asp-items="Model.Filter.Categories"
                        all-text="Tüm Kategoriler" class="form-select form-select-sm form-select-solid fs-7"
                        data-control="select2" />
                </div>

                <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                    <label class="form-label fs-7 fw-bold text-gray-700">Stok Durumu</label>
                    <app-filter-select asp-for="Filter.HasStock" true-text="Stokta Var" false-text="Stok Yok"
                        all-text="Tümü" class="form-select form-select-sm form-select-solid fs-7" data-control="select2"
                        data-hide-search="true" />
                </div>

                <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                    <label class="form-label fs-7 fw-bold text-gray-700">Satış Durumu</label>
                    <app-filter-select asp-for="Filter.IsOnSale" true-text="Satışa Açık" false-text="Satışa Kapalı"
                        all-text="Tümü" class="form-select form-select-sm form-select-solid fs-7" data-control="select2"
                        data-hide-search="true" />
                </div>

                <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                    <label class="form-label fs-7 fw-bold text-gray-700">Maliyet Durumu</label>
                    <app-filter-select asp-for="Filter.CostStatus"
                        class="form-select form-select-sm form-select-solid fs-7" data-control="select2"
                        data-hide-search="true" />
                </div>

                <div class="col-12 col-md-4 col-lg-2 d-flex gap-2 justify-content-md-end">
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="ki-outline ki-filter fs-4 me-1"></i> Uygula
                    </button>
                    <a href="@Url.Action("Costs")" class="btn btn-sm btn-light w-100">
                        <i class="ki-outline ki-arrows-circle fs-4 me-1"></i> Temizle
                    </a>
                </div>
            </div>
        </form>
    </div>

    <div class="separator separator-dashed my-5"></div>

    <div class="card-body pt-0">
        <div id="bulkSaveContainer"
            class="d-none mb-5 p-4 bg-light-primary rounded d-flex align-items-center justify-content-between border border-primary border-dashed">
            <span class="text-primary fw-bold fs-7">
                <i class="ki-outline ki-information-5 text-primary fs-4 me-2"></i>
                <span id="changeCount">0</span> adet maliyet bilgisinde değişiklik yapıldı.
            </span>
            <button type="button" class="btn btn-sm btn-primary" id="btnBulkSave">
                <i class="ki-outline ki-check-square fs-4 me-1"></i> Değişiklikleri Kaydet
            </button>
        </div>
        <div class="table-responsive">
            <table class="table align-middle table-row-dashed fs-7 gy-3" id="costTable"
                data-save-url="@Url.Action("SaveCosts", "Product")">
                <thead>
                    <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                        <th class="min-w-250px ps-4">Ürün Bilgisi</th>
                        <th class="min-w-250px text-center">Alış Fiyatı <br /><span
                                class="text-gray-400 fs-9 fw-normal text-lowercase">(zorunlu)</span></th>
                        <th class="min-w-250px text-center">Komisyon Oranı (%) <br /><span
                                class="text-gray-400 fs-9 fw-normal text-lowercase">(manuel / otomatik)</span></th>
                        <th class="min-w-250px text-center">Kargo Ücreti (₺) <br /><span
                                class="text-gray-400 fs-9 fw-normal text-lowercase">(manuel / otomatik)</span></th>
                        <th class="min-w-100px text-center">İşlem</th>
                    </tr>
                </thead>
                <tbody class="fw-semibold text-gray-600">
                    @if (Model.Products != null && Model.Products.Items.Any())
                    {
                        @foreach (var product in Model.Products.Items)
                        {
                            <tr data-product-id="@product.Id" class="cost-row">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="symbol symbol-40px me-3">
                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                            {
                                                <div class="symbol-label" style="background-image:url(@product.ImageUrl);"></div>
                                            }
                                            else
                                            {
                                                <div class="symbol-label bg-light-primary text-primary fw-bold">@product.Name?[0]
                                                </div>
                                            }
                                        </div>
                                        <div class="d-flex flex-column">
                                            <span class="text-gray-800 fw-bold fs-7">@product.Name.Truncate(35)</span>
                                            <span class="text-muted fs-9">@product.Barcode</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <input type="number" step="0.01" data-field="purchasePrice"
                                        value="@(product.PurchasePrice.HasValue? product.PurchasePrice.Value.ToJsFormat() : "")"
                                        class="form-control form-control-sm text-center cost-input mx-auto w-125px @(!product.PurchasePrice.HasValue ? "border-danger border-dashed bg-light-danger" : "form-control-solid")"
                                        placeholder="Manuel" />
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <input type="number" step="0.01" data-field="manualCommissionRate"
                                            value="@(product.ManualCommissionRate.HasValue? product.ManualCommissionRate.Value.ToJsFormat() : "")"
                                            class="form-control form-control-sm form-control-solid text-center cost-input w-125px"
                                            placeholder="Manuel" />
                                        <div class="vr h-20px opacity-25"></div>
                                        <div class="position-relative d-flex align-items-center">
                                            <input type="text"
                                                value="@(product.AutomatedCommissionRate.HasValue? product.AutomatedCommissionRate.Value.ToJsFormat() : "")"
                                                placeholder="Hesaplanamadı"
                                                class="form-control form-control-sm form-control-solid text-center bg-light-warning w-125px fw-bold"
                                                readonly />


                                            @if (product.AutomatedCommissionRate > 0)
                                            {
                                                <i class="ki-outline ki-calculator fs-6 text-warning position-absolute end-0 me-2"
                                                    data-bs-toggle="tooltip" title="Bu oran otomatik hesaplanmıştır."></i>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <input type="number" step="0.01" data-field="manualShippingCost"
                                            value="@(product.ManualShippingCost.HasValue? product.ManualShippingCost.Value.ToJsFormat() : "")"
                                            class="form-control form-control-sm form-control-solid text-center cost-input w-125px"
                                            placeholder="Manuel" />
                                        <div class="vr h-20px opacity-25"></div>
                                        <div class="position-relative d-flex align-items-center">
                                            <input type="text"
                                                value="@(product.AutomatedShippingCost.HasValue? product.AutomatedShippingCost.Value.ToJsFormat() : "")"
                                                placeholder="Hesaplanamadı"
                                                class="form-control form-control-sm form-control-solid text-center bg-light-warning w-125px fw-bold"
                                                readonly />

                                            @if (product.AutomatedShippingCost > 0)
                                            {
                                                <i class="ki-outline ki-calculator fs-6 text-warning position-absolute end-0 me-2"
                                                    data-bs-toggle="tooltip" title="Bu ücret otomatik hesaplanmıştır."></i>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-sm btn-icon btn-light-primary btn-save-row d-none"
                                            title="Kaydet"><i class="ki-outline ki-check fs-2"></i></button>
                                        <button type="button" class="btn btn-sm btn-icon btn-light-danger btn-reset-row d-none"
                                            title="İptal"><i class="ki-outline ki-cross fs-2"></i></button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        <app-pagination model="@Model.Products" controller="Product" action="Costs" form-id="filterForm" />
    </div>
</div>
@section Scripts {
    <script src="~/assets/js/pages/products/costs.js"></script>
}
